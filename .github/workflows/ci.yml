name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'
  # Increase Node.js heap size for large test suites (12k+ tests)
  NODE_OPTIONS: '--max-old-space-size=8192'

jobs:
  should-skip:
    name: Check Skip Conditions
    runs-on: ubuntu-latest
    outputs:
      skip-full-ci: ${{ steps.check.outputs.skip-full-ci }}
      is-version-pr: ${{ steps.check.outputs.is-version-pr }}
    steps:
      - id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Check if this is a Version PR merge push (commit message contains "chore: release")
          if [[ "$COMMIT_MSG" == *"chore: release"* ]] && [[ "$EVENT_NAME" == "push" ]]; then
            echo "skip-full-ci=true" >> $GITHUB_OUTPUT
            echo "::notice::Skipping full CI - Version PR merge detected"
          else
            echo "skip-full-ci=false" >> $GITHUB_OUTPUT
          fi

          # Check if this is a Version PR
          if [[ "$PR_TITLE" == "chore: release"* ]]; then
            echo "is-version-pr=true" >> $GITHUB_OUTPUT
            echo "::notice::Version PR detected - will run quick check only"
          else
            echo "is-version-pr=false" >> $GITHUB_OUTPUT
          fi

  lint:
    name: Lint
    needs: should-skip
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.should-skip.outputs.skip-full-ci != 'true' && needs.should-skip.outputs.is-version-pr != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run lint
        run: pnpm lint

  typecheck:
    name: Typecheck
    needs: should-skip
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.should-skip.outputs.skip-full-ci != 'true' && needs.should-skip.outputs.is-version-pr != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-typecheck-${{ hashFiles('**/tsconfig.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-typecheck-${{ hashFiles('**/tsconfig.json') }}-
            ${{ runner.os }}-turbo-typecheck-
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Run typecheck
        run: pnpm typecheck

  test:
    name: Test (${{ matrix.os }}, Node ${{ matrix.node }})
    needs: should-skip
    runs-on: ${{ matrix.os }}
    # 45 min timeout for 12k+ tests across matrix combinations
    timeout-minutes: 45
    if: needs.should-skip.outputs.skip-full-ci != 'true' && needs.should-skip.outputs.is-version-pr != 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: ['20', '22']
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-node${{ matrix.node }}-turbo-test-${{ hashFiles('**/vitest.config.*') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-node${{ matrix.node }}-turbo-test-${{ hashFiles('**/vitest.config.*') }}-
            ${{ runner.os }}-node${{ matrix.node }}-turbo-test-
            ${{ runner.os }}-node${{ matrix.node }}-turbo-
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Run tests
        run: pnpm test:run
        env:
          # Extra memory for large test suites
          NODE_OPTIONS: '--max-old-space-size=8192'

  # Quick check for Version PRs (fast pass)
  quick-check:
    name: Quick Check (Version PR)
    needs: should-skip
    if: needs.should-skip.outputs.is-version-pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Version PR Quick Pass
        run: echo "✅ Version PR detected - skipping full CI"

  # Non-blocking check for changeset presence on PRs
  changeset-check:
    name: Changeset Check
    needs: should-skip
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.should-skip.outputs.is-version-pr != 'true'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changeset
        id: check
        run: |
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')
          echo "changeset_count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
          if [ "$CHANGESET_COUNT" -eq 0 ]; then
            echo "::warning::No changeset found. If this PR introduces user-facing changes, please run 'pnpm changeset' to add one."
            echo "has_changeset=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Found $CHANGESET_COUNT changeset(s)"
            echo "has_changeset=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (no changeset)
        if: steps.check.outputs.has_changeset == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `⚠️ **No changeset detected**

            This PR doesn't include a changeset. If this PR introduces user-facing changes, please add one:

            \`\`\`bash
            pnpm changeset
            \`\`\`

            **When to add a changeset:**
            - ✅ Bug fixes, new features, breaking changes
            - ❌ CI/docs-only changes, refactoring with no user impact

            See [.changeset/README.md](.changeset/README.md) for guidelines.`;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('No changeset detected')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
